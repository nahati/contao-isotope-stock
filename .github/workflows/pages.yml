name: CI

on:
    push:
    pull_request:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

    tests:
        name: PHPUnit Tests
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php: [8.1]

        steps:
            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: dom, fileinfo, filter, gd, hash, intl, json, mbstring, mysqli, pcre, pdo_mysql, zlib
                  coverage: xdebug
              env:
                  COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Initialize the database
              run: |
                  sudo /etc/init.d/mysql start
                  mysql -uroot -proot -e "CREATE database ContaoIsotopeStockBundleTest"

            - name: Checkout
              uses: actions/checkout@v3

            - name: Install the dependencies
              run: composer install --no-interaction --no-progress

            - name: Create directories for test reports
              run: mkdir -p docs/unit docs/integration

            - name: Run PHPUnit with code coverage
              run: vendor/bin/phpunit --colors=always --testsuite=unit --coverage-html docs/unit --testdox-html docs/unit/testdox.html
              env:
                  DATABASE_URL: mysql://root:root@127.0.0.1:3306/ContaoIsotopeStockBundleTest

            - name: Run the functional tests with PDO MySQL
              run: vendor/bin/phpunit --testsuite=integration --colors=always --coverage-html docs/integration --testdox-html docs/integration/testdox.html
              env:
                  DATABASE_URL: mysql://root:root@127.0.0.1:3306/ContaoIsotopeStockBundleTest

            - name: Upload test reports as artifacts
              uses: actions/upload-artifact@v2
              with:
                  name: test-reports
                  path: |
                      docs/unit
                      docs/integration
