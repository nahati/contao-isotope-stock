name: CI

on:
    pull_request:
    push:

jobs:
    tests:
        name: PHP ${{ matrix.php }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php: [8.1, 8.2, 8.3]
        steps:
            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: dom,fileinfo,filter,gd,hash,intl,json,mbstring,mysqli,pcre,pdo_mysql,zlib
                  coverage: xdebug
              env:
                  COMPOSER_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Initialize the database
              run: |
                  sudo /etc/init.d/mysql start
                  mysql -uroot -proot -e "CREATE database ContaoIsotopeStockBundleTest"

            - name: Checkout
              uses: actions/checkout@v3

            - name: Install the dependencies
              run: composer install --no-interaction --no-progress

            - name: Create directories for test reports
              run: mkdir -p docs/unit docs/integration

            - name: Run the functional tests with PDO MySQL
              run: vendor/bin/phpunit --testsuite=integrationCart --colors=always --coverage-html docs/integrationCart --testdox-text docs/integrationCart/testdox.txt
              env:
                  DATABASE_URL: mysql://root:root@127.0.0.1:3306/ContaoIsotopeStockBundleTest

            - name: Run the functional tests with PDO MySQL
              run: vendor/bin/phpunit --testsuite=integrationOrder --filter PreCheckoutListenerTest --colors=always --coverage-html docs/integrationOrder --testdox-text docs/integrationOrder/testdox.txt
              env:
                  DATABASE_URL: mysql://root:root@127.0.0.1:3306/ContaoIsotopeStockBundleTest

            - name: Run the functional tests with PDO MySQL
              run: vendor/bin/phpunit --testsuite=integrationOrder --filter PostCheckoutListenerTest --colors=always --coverage-html docs/integrationOrder --testdox-text docs/integrationOrder/testdox.txt
              env:
                  DATABASE_URL: mysql://root:root@127.0.0.1:3306/ContaoIsotopeStockBundleTest

            - name: Upload test reports as artifacts
              uses: actions/upload-artifact@v2
              with:
                  name: test-reports
                  path: |
                      docs/integrationCart
                      docs/integrationOrder
